{% extends "layout.html" %}

{% block title %}Управление пользователями{% endblock %}

{% block content %}
  <h2>Управление пользователями</h2>
  {% if user.role == 'admin' %}
  <section>
    <h3>Получить пользователя по ID (/users/{id})</h3>
    <form id="form-get-user">
      <label>ID пользователя:
        <input name="id" type="text" placeholder="UUID пользователя" required />
      </label>
      <button type="submit">Получить</button>
    </form>
    <pre id="out-get-user"></pre>
  </section>

  <section>
    <h3>Обновить пользователя (/users/{id})</h3>
    <form id="form-patch-user">
      <label>ID пользователя:
        <input name="id" type="text" placeholder="UUID пользователя" required />
      </label>
      <label>Email:
        <input name="email" type="email" placeholder="новый email" />
      </label>
      <label>Password:
        <input name="password" type="password" placeholder="новый пароль" />
      </label>
      <label>Имя:
        <input name="first_name" type="text" placeholder="новое имя" />
      </label>
      <label>Фамилия:
        <input name="last_name" type="text" placeholder="новая фамилия" />
      </label>
      <label>Superuser:
        <input name="is_superuser" type="checkbox" />
      </label>
      <label>Verified:
        <input name="is_verified" type="checkbox" />
      </label>
      <label>Active:
        <input name="is_active" type="checkbox" />
      </label>
      <button type="submit">Обновить</button>
    </form>
    <pre id="out-patch-user"></pre>
  </section>

  <section>
    <h3>Удалить пользователя (/users/{id})</h3>
    <form id="form-delete-user">
      <label>ID пользователя:
        <input name="id" type="text" placeholder="UUID пользователя" required />
      </label>
      <button type="submit">Удалить</button>
    </form>
    <pre id="out-delete-user"></pre>
  </section>
  {% endif %}

  <script>
    const API = `${window.location.protocol}//${window.location.host}`;
    const opts = { credentials: 'include', headers: { 'Content-Type': 'application/json' } };

    document.getElementById('form-get-user').onsubmit = async e => {
      e.preventDefault();
      const id = e.target.id.value;
      const res = await fetch(`${API}/users/${id}`, opts);
      document.getElementById('out-get-user').textContent = res.ok
        ? JSON.stringify(await res.json(), null, 2)
        : `Ошибка ${res.status}`;
    };

    document.getElementById('form-patch-user').onsubmit = async e => {
      e.preventDefault();
      const f = e.target;
      const id = f.id.value;
      const body = {};
      if (f.email.value) body.email = f.email.value;
      if (f.password.value) body.password = f.password.value;
      if (f.first_name.value) body.first_name = f.first_name.value;
      if (f.last_name.value) body.last_name = f.last_name.value;
      body.is_superuser = f.is_superuser.checked;
      body.is_verified = f.is_verified.checked;
      body.is_active = f.is_active.checked;

      const res = await fetch(`${API}/users/${id}`, {
        ...opts, method: 'PATCH', body: JSON.stringify(body)
      });
      document.getElementById('out-patch-user').textContent = res.ok
        ? JSON.stringify(await res.json(), null, 2)
        : `Ошибка ${res.status}: ${JSON.stringify(await res.json())}`;
    };

    document.getElementById('form-delete-user').onsubmit = async e => {
      e.preventDefault();
      const id = e.target.id.value;
      const res = await fetch(`${API}/users/${id}`, {
        ...opts, method: 'DELETE'
      });
      document.getElementById('out-delete-user').textContent = res.ok
        ? 'Пользователь удалён'
        : `Ошибка ${res.status}`;
    };
  </script>
{% endblock %}
